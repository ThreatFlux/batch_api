# Templates Guide

This guide explains how to customize the output format of the threat model generator using templates.

## Template System

The threat model generator uses Jinja2 templates to format its output. Templates are stored in YAML format in `src/threat_model/prompts/templates.yaml`.

## Default Templates

### Section Template

The default section template structures each threat model section:

```yaml
section_template: |
  # Threat Model: {{ technique_name }} ({{ technique_id }})

  ## Overview
  {{ description }}

  ## Attack Vectors
  {% for vector in attack_vectors %}
  ### {{ vector.name }}
  - Description: {{ vector.description }}
  - Scenario: {{ vector.scenario }}
  
  #### Audit Log Example
  ```json
  {{ vector.log_example }}
  ```
  {% endfor %}

  ## Detection Strategy
  ```sql
  {{ detection_strategy.sql_rule }}
  ```

  ### Behavioral Analytics
  - Baseline Period: {{ detection_strategy.baseline_period }}
  - Anomaly Detection: {{ detection_strategy.anomaly_detection }}
  - Sequence Analysis: {{ detection_strategy.sequence_analysis }}

  ## Controls
  {% for control in controls %}
  ### {{ control.name }}
  ```json
  {{ control.implementation | tojson(indent=2) }}
  ```
  {% endfor %}
```

## Customizing Templates

### Creating Custom Templates

1. Create a new YAML file with your templates:
```yaml
custom_section_template: |
  # Custom Threat Model: {{ technique_name }}
  [Your custom format here]
```

2. Update the generator to use your template:
```python
generator = ThreatModelGenerator(
    template_path="path/to/custom_templates.yaml"
)
```

### Template Variables

Available variables include:

#### Technique Information
- `technique_id`: MITRE technique ID
- `technique_name`: Name of the technique
- `description`: Detailed description
- `tactic`: Associated MITRE tactic

#### Detection Data
- `detection_strategy`:
  - `sql_rule`: SQL detection rule
  - `baseline_period`: Baseline monitoring period
  - `anomaly_detection`: Anomaly detection settings
  - `sequence_analysis`: Sequence analysis configuration

#### Controls
- `controls`: List of security controls
  - `name`: Control name
  - `type`: Control type (preventive/detective)
  - `implementation`: Implementation details

#### Audit Operations
- `operations`: List of relevant audit operations
  - `operation`: Operation name
  - `friendly_name`: Human-readable name
  - `description`: Operation description

### Template Functions

Available Jinja2 filters:

- `tojson`: Convert object to JSON string
- `indent`: Indent text blocks
- `trim`: Remove whitespace
- `escape`: HTML escape text

Example:
```yaml
control_template: |
  {
    "name": "{{ control.name }}",
    "implementation": {{ control.implementation | tojson(indent=2) }}
  }
```

## Batch Processing Templates

For batch processing, additional templates are available:

### Batch Header Template
```yaml
batch_header: |
  # Microsoft 365 & Entra ID Threat Models
  Generated: {{ timestamp }}
  
  ## Table of Contents
  {% for technique in techniques %}
  - [{{ technique.name }}](#{{ technique.id }})
  {% endfor %}
```

### Batch Footer Template
```yaml
batch_footer: |
  ---
  Generated by ThreatFlux Microsoft 365 Threat Model Generator
  Version: {{ version }}
```

## Docker Integration

When using Docker, templates can be mounted as volumes:

```bash
docker run -it --rm \
    -v $(pwd)/custom_templates:/workspace/templates \
    -e TEMPLATE_PATH=/workspace/templates/custom.yaml \
    threatflux/batch-api:latest
```

## Best Practices

1. **Version Control**: Keep templates in version control
2. **Documentation**: Document custom variables and formats
3. **Testing**: Test templates with sample data
4. **Modularity**: Break complex templates into reusable components
5. **Validation**: Validate template syntax before deployment

## Example: Custom Template

```yaml
# custom_template.yaml
threat_model_template: |
  # {{ technique_name }} ({{ technique_id }})
  
  ## Risk Assessment
  - Level: {{ risk_level }}
  - Impact: {{ impact }}
  - Likelihood: {{ likelihood }}
  
  ## Detection
  ```sql
  {{ detection_strategy.sql_rule }}
  ```
  
  ## Mitigation
  {% for control in controls %}
  ### {{ control.name }}
  {{ control.description }}
  {% endfor %}
  
  ## References
  - [MITRE](https://attack.mitre.org/techniques/{{ technique_id }})
  - [Microsoft Documentation]({{ ms_docs_url }})
